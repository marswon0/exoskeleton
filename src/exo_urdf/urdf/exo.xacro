<?xml version="1.0"?>
<robot name="exoskeleton_leg" xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- Properties -->
  <xacro:property name="motor_mass" value="3" />  <!-- Hip / Knee motor mass (kg) -->
  <xacro:property name="base_mass" value="1.0" />   <!-- Base structure mass -->

  <!-- Base Link with Motor Mass -->
  <link name="base_link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="4.0"/>  <!-- 1.0kg base + 3.0kg motor -->
      <!-- Empirical inertia for 3kg motor (scaled from original) -->
      <inertia 
        ixx="0.04" ixy="0" ixz="0"
        iyy="0.04" iyz="0"
        izz="0.025"/>
    </inertial>
    
    <visual>
      <geometry><box size="0.1 0.1 0.05"/></geometry>
      <material name="black"><color rgba="0 0 0 1"/></material>
    </visual>
    
    <collision>
      <geometry><box size="0.1 0.1 0.05"/></geometry>
    </collision>
  </link>

  <!-- Gazebo Configurations -->
  <gazebo reference="base_link">
    <material>Gazebo/DarkGrey</material>
    <mu1>0.5</mu1>
    <mu2>0.5</mu2>
    <kp>500000</kp>  <!-- Reduced stiffness for heavy mass -->
    <kd>500</kd>     <!-- Increased damping -->
  </gazebo>

  <!-- Heavy Hip Joint -->
  <joint name="hip_joint" type="revolute">
    <parent link="base_link"/>
    <child link="thigh_link"/>
    
    <!-- Positioned 2.5cm below base center-->
    <origin xyz="0 0 -0.025" rpy="0 0 0"/>
    
    <!-- Z-axis rotation for flexion/extension -->
    <axis xyz="0 0 1"/>
    
    <!-- Limits for ISO 13485 Compliance -->
    <limit 
      effort="400"     
      velocity="2"      
      lower="-0.7854"     
      upper="0.7854" 
    />
    <!-- 300Nm torque (heavy motor), Conservative 2 rad/s (~115°/s), +-45° hard limit -->
    
    <safety_controller 
      k_velocity="100"           
      soft_lower_limit="-0.75"   
      soft_upper_limit="0.75"    
    />
    <!-- Stronger braking --> <!-- -43° soft limit --> <!-- +43° soft limit -->
    
    <!-- High damping for motor inertia -->
    <dynamics 
      damping="1.5"     
      friction="0.3"    
    />
  </joint>
<!-- Increased viscous damping --> <!-- Higher static friction -->

<!-- Thigh Link with 3kg Motor Mass -->
<link name="thigh_link">
  <visual>
    <geometry><cylinder length="0.3" radius="0.03"/></geometry>
    <origin xyz="0 0 -0.15" rpy="0 0 0"/>
    <material name="blue"><color rgba="0 0 0.8 1"/></material>
  </visual>

  <collision>
    <geometry><cylinder length="0.3" radius="0.03"/></geometry>
    <origin xyz="0 0 -0.15" rpy="0 0 0"/>
  </collision>

  <!-- Optimized Inertial for 3.5kg Total Mass -->
  <inertial>
    <origin xyz="0 0 0.2786"/>  <!-- COM: (0.5*0.15 + 3*0.3)/3.5 -->
    <mass value="3.5"/>
    <inertia 
      ixx="0.1135" ixy="0" ixz="0"
      iyy="0.1135" iyz="0"
      izz="0.000225"/>  <!-- Dominated by axial motor inertia -->
  </inertial>
</link>

<gazebo reference="thigh_link">
  <mu1>0.8</mu1>  <!-- Increased friction for heavy load -->
  <mu2>0.8</mu2>
  <kp>2000000</kp>  <!-- Higher stiffness -->
  <kd>2000</kd>    <!-- Increased damping -->
</gazebo>

<!-- Optimized Knee Joint -->
<joint name="knee_joint" type="revolute">
  <parent link="thigh_link"/>
  <child link="shank_link"/>
  
  <!-- Corrected Origin (0.3m from parent origin) -->
  <origin xyz="0 0 -0.3" rpy="0 0 0"/>  <!-- End of 0.3m thigh cylinder -->
  
  <!-- Mediolateral Rotation Axis (Y-axis for sagittal plane motion) -->
  <axis xyz="0 1 0"/>
  
  <!-- Enhanced Dynamics for 3kg Motor -->
  <dynamics damping="1.2" friction="0.4"/>  <!-- 8x higher damping than before -->
  
  <!-- ISO 13485 Compliant Limits -->
  <!-- 150° = 2.618 rad -->
  <limit effort="350"         
         velocity="2.0"      
         lower="0" 
         upper="2.3"/>      

  <!-- Stronger braking force --> 
  <!-- 5.7° buffer for low limit--> 
  <!-- 6.8° buffer for upper limit--> 
  <safety_controller 
    k_velocity="150"          
    soft_lower_limit="0.05"    
    soft_upper_limit="2.2"/>  
</joint>

<!-- Shank Link -->
<link name="shank_link">
  <visual>
    <geometry><cylinder length="0.35" radius="0.025"/></geometry>
    <origin xyz="0 0 -0.175" rpy="0 0 0"/>
    <material name="red"><color rgba="0.8 0 0 1"/></material>
  </visual>
  <collision><geometry><cylinder length="0.35" radius="0.025"/></geometry></collision>
  <inertial>
    <mass value="0.3"/>
    <inertia ixx="0.003" ixy="0" ixz="0" iyy="0.003" iyz="0" izz="0.003"/>
  </inertial>
  <!-- Gazebo Attr -->
  <gazebo reference="shank_link">
    <mu1>0.2</mu1>  <!-- Contact Friction Coefficient -->
    <mu2>0.2</mu2>
    <kp>1000000</kp>  <!-- Contact Stiffness [N/m] -->
    <kd>100</kd>      <!-- Contact Damping [N·s/m] -->
  </gazebo>
</link>

<!-- Ankle Joint -->
<joint name="ankle_joint" type="revolute">
  <parent link="shank_link"/>
  <child link="foot_link"/>
  <!-- Position ankle joint at the end of shank_link -->
  <origin xyz="0 0 -0.35" rpy="0 0 0"/> <!-- Negative Z to move down from shank_link -->
  <axis xyz="0 1 0"/>
  <dynamics damping="0.03" friction="0.005"/>
  <!--
    typical ROM for ankle joint is 20° dorsiflexion and 50° plantarflexion
    Dorsiflexion (upward movement)‌: 0 - 20° (0 - 0.35rad)
    Plantarflexion (downward movement)‌: 0 - 55° (0 - 0.96rad)
  -->
  <limit effort="300" velocity="3.0" lower="-0.3" upper="0.3"/>
  <safety_controller k_velocity="50" soft_lower_limit="-0.25" soft_upper_limit="0.25"/>
</joint>

<!-- Foot Link -->
<link name="foot_link">
  <visual>
    <geometry><box size="0.15 0.05 0.01"/></geometry>
    <material name="gray"><color rgba="0.5 0.5 0.5 1"/></material>
  </visual>
  <collision><geometry><box size="0.15 0.05 0.01"/></geometry></collision>
  <inertial>
    <mass value="0.1"/>
    <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
  </inertial>
  <!-- Gazebo Attr -->
  <gazebo reference="foot_link">
    <mu1>0.2</mu1>  <!-- Contact Friction Coefficient -->
    <mu2>0.2</mu2>
    <kp>1000000</kp>  <!-- Contact Stiffness [N/m] -->
    <kd>100</kd>      <!-- Contact Damping [N·s/m] -->
  </gazebo>
</link>

<!-- Transmissions -->
<transmission name="hip_transmission">
  <type>transmission_interface/SimpleTransmission</type>
  <actuator name="hip_motor">
    <hardwareInterface>Effort</hardwareInterface>
  </actuator>
  <joint name="hip_joint"/>
</transmission>

<transmission name="knee_transmission">
  <type>transmission_interface/SimpleTransmission</type>
  <actuator name="knee_motor">
    <hardwareInterface>Effort</hardwareInterface>
  </actuator>
  <joint name="knee_joint"/>
</transmission>

<transmission name="ankle_transmission">
  <type>transmission_interface/SimpleTransmission</type>
  <actuator name="ankle_motor">
    <hardwareInterface>Effort</hardwareInterface>
  </actuator>
  <joint name="ankle_joint"/>
</transmission>

<!-- Gazebo Sensor Plugin -->
<!-- IMU -->
<gazebo reference="thigh_link">
  <sensor type="imu" name="thigh_link">
    <always_on>true</always_on>
    <update_rate>100</update_rate>
    <plugin filename="libgazebo_ros_imu_sensor.so" name="imu_plugin">
      <ros>
        <namespace>/</namespace>
        <remapping>~/out:=/imu/thigh_link_data</remapping>  <!-- custom topic name -->
      </ros>
      <frame_name>thigh_link</frame_name>  <!-- must be the same with reference -->
    </plugin>
  </sensor>
</gazebo>

<gazebo reference="foot_link">
  <sensor type="imu" name="foot_imu">
    <always_on>true</always_on>
    <update_rate>100</update_rate>
    <plugin filename="libgazebo_ros_imu_sensor.so" name="imu_plugin">
      <ros>
        <namespace>/</namespace>
        <remapping>~/out:=/imu/foot_link_data</remapping>  <!-- custom topic name -->
      </ros>
      <frame_name>foot_link</frame_name>  <!-- must be the same with reference -->
    </plugin>
  </sensor>
</gazebo>

<!-- Force Torque Sensors -->
<gazebo reference="thigh_link">
  <sensor name="hip_torque_sensor" type="force_torque">
    <update_rate>100</update_rate>
    <plugin filename="libgazebo_ros_ft_sensor.so" name="ft_sensor_plugin">
      <topic>hip_joint_torque</topic>
      <update_rate>100</update_rate>
    </plugin>
    <force_torque>
      <frame>child</frame>  
      <measure_direction>child_to_parent</measure_direction>
    </force_torque>
    <noise>
      <type>gaussian</type>
      <mean>0</mean>
      <stddev>0.02</stddev>  <!-- 2% std noise -->
    </noise>
  </sensor>
</gazebo>

<gazebo reference="shank_link">
  <sensor name="knee_torque_sensor" type="force_torque">
    <update_rate>100</update_rate>
    <plugin filename="libgazebo_ros_ft_sensor.so" name="ft_sensor_plugin">
      <topic>knee_joint_torque</topic>
      <update_rate>100</update_rate>
    </plugin>
    <force_torque>
      <frame>child</frame>  
      <measure_direction>child_to_parent</measure_direction>
    </force_torque>
    <noise>
      <type>gaussian</type>
      <mean>0</mean>
      <stddev>0.02</stddev>  <!-- 2% std noise -->
    </noise>
  </sensor>
</gazebo>

<gazebo reference="foot_link">
  <sensor name="ankle_torque_sensor" type="force_torque">
    <update_rate>100</update_rate>
    <plugin filename="libgazebo_ros_ft_sensor.so" name="ft_sensor_plugin">
      <topic>ankle_joint_torque</topic>
      <update_rate>100</update_rate>
    </plugin>
    <force_torque>
      <frame>child</frame> 
      <measure_direction>child_to_parent</measure_direction>
    </force_torque>
    <noise>
      <type>gaussian</type>
      <mean>0</mean>
      <stddev>0.02</stddev>  <!-- 2% std noise -->
    </noise>
  </sensor>
</gazebo>

  <!-- Contact Sensor -->
  <gazebo reference="foot_link">
    <sensor type="contact" name="foot_contact">
      <always_on>true</always_on>
      <update_rate>50</update_rate>
    </sensor>
  </gazebo>

  <gazebo>
    <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
      <robotNamespace>/exoskeleton</robotNamespace>
    </plugin>
  </gazebo>

  <gazebo>
    <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
      <robotNamespace>/exoskeleton</robotNamespace>
    </plugin>
  </gazebo>

</robot>
